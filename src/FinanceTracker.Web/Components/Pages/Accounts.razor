@page "/accounts"
@using FinanceTracker.Web.States.Accounts
@inject AccountState AccountState
@rendermode InteractiveServer

<Sidebar />

<div class="main-content">
    <TopHeader />

    <div class="page-header">
        <h1 class="page-title">Cuentas</h1>
        <button class="btn-primary" @onclick="OpenAddModal">
            <span class="material-icons">add</span> Nueva Cuenta
        </button>
    </div>

    <div class="accounts-summary">
        <div class="summary-card">
            <div class="summary-icon">
                <span class="material-icons" style="font-size: 32px;">account_balance_wallet</span>
            </div>
            <div class="summary-info">
                <div class="summary-label">Balance Total</div>
                <div class="summary-value">$@AccountState.Accounts.Sum(a => a.Balance).ToString("N2")</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">
                <span class="material-icons" style="font-size: 32px;">account_balance</span>
            </div>
            <div class="summary-info">
                <div class="summary-label">Total Cuentas</div>
                <div class="summary-value">@AccountState.Accounts.Count</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">
                <span class="material-icons" style="font-size: 32px;">trending_up</span>
            </div>
            <div class="summary-info">
                <div class="summary-label">Cuenta Mayor Balance</div>
                <div class="summary-value">$@(AccountState.Accounts.Any() ? AccountState.Accounts.Max(a => a.Balance).ToString("N2") : "0.00")</div>
            </div>
        </div>
    </div>

    <div class="accounts-grid">
        @foreach (var account in AccountState.Accounts)
        {
            <div class="account-card" style="background: linear-gradient(135deg, @account.Color 0%, @account.Color + "cc" 100%);">
                <div class="account-header">
                    <div class="account-icon">
                        <span class="material-icons" style="font-size: 36px;">@account.Icon</span>
                    </div>
                    <div class="account-actions">
                        <button class="btn-icon-light" @onclick="() => OpenEditModal(account)">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn-icon-light" @onclick="() => DeleteAccount(account.Id)">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
                <div class="account-info">
                    <div class="account-name">@account.Name</div>
                    <div class="account-balance">$@account.Balance.ToString("N2")</div>
                    <div class="account-currency">@account.Currency</div>
                </div>
                <div class="account-footer">
                    <button class="account-action-btn" @onclick="() => OpenTransferModal(account)">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">swap_horiz</span> Transferir
                    </button>
                    <button class="account-action-btn" @onclick="() => OpenDepositModal(account)">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">add_circle</span> Depositar
                    </button>
                </div>
            </div>
        }
    </div>

    @if (showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>@(isEditing ? "Editar" : "Nueva") Cuenta</h2>
                    <button class="btn-close" @onclick="CloseModal">??</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Nombre de la Cuenta</label>
                        <input type="text" class="form-input" @bind="currentAccount.Name" placeholder="Ej: Cuenta Principal" />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Balance Inicial</label>
                            <input type="number" step="0.01" class="form-input" @bind="currentAccount.Balance" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>Moneda</label>
                            <select class="form-input" @bind="currentAccount.Currency">
                                <option value="USD">USD - Dólar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="MXN">MXN - Peso</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Icono (Material Icon)</label>
                            <input type="text" class="form-input" @bind="currentAccount.Icon" placeholder="credit_card" />
                        </div>
                        <div class="form-group">
                            <label>Color (Hex)</label>
                            <input type="text" class="form-input" @bind="currentAccount.Color" placeholder="#3b82f6" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Vista Previa</label>
                        <div class="account-preview" style="background: linear-gradient(135deg, @currentAccount.Color 0%, @currentAccount.Color + "cc" 100%);">
                            <div style="font-size: 32px;">
                                <span class="material-icons" style="font-size: 48px;">@currentAccount.Icon</span>
                            </div>
                            <div style="font-size: 18px; font-weight: 600; margin-top: 10px;">@currentAccount.Name</div>
                            <div style="font-size: 24px; font-weight: 700; margin-top: 5px;">$@currentAccount.Balance.ToString("N2")</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" @onclick="CloseModal">Cancelar</button>
                    <button class="btn-primary" @onclick="SaveAccount">Guardar</button>
                </div>
            </div>
        </div>
    }

    @if (showDepositModal)
    {
        <div class="modal-overlay" @onclick="CloseDepositModal">
            <div class="modal-content modal-small" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">account_balance_wallet</span>
                        Depositar a @selectedAccount?.Name
                    </h2>
                    <button class="btn-close" @onclick="CloseDepositModal">??</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Monto a Depositar</label>
                        <input type="number" step="0.01" class="form-input" @bind="depositAmount" placeholder="0.00" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" @onclick="CloseDepositModal">Cancelar</button>
                    <button class="btn-primary" @onclick="ProcessDeposit">Depositar</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool showModal = false;
    private bool showDepositModal = false;
    private bool isEditing = false;
    private AccountModel currentAccount = new();
    private AccountModel? selectedAccount;
    private decimal depositAmount = 0;

    protected override void OnInitialized()
    {
        AccountState.OnChange += StateHasChanged;
    }

    private void OpenAddModal()
    {
        isEditing = false;
        currentAccount = new AccountModel 
        { 
            Id = Guid.NewGuid(), 
            Icon = "credit_card", 
            Color = "#3b82f6",
            Currency = "USD"
        };
        showModal = true;
    }

    private void OpenEditModal(AccountModel account)
    {
        isEditing = true;
        currentAccount = new AccountModel
        {
            Id = account.Id,
            Name = account.Name,
            Balance = account.Balance,
            Currency = account.Currency,
            Icon = account.Icon,
            Color = account.Color
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentAccount = new();
    }

    private void SaveAccount()
    {
        if (string.IsNullOrWhiteSpace(currentAccount.Name))
            return;

        if (isEditing)
        {
            AccountState.UpdateAccount(currentAccount);
        }
        else
        {
            AccountState.AddAccount(currentAccount);
        }

        CloseModal();
    }

    private void DeleteAccount(Guid id)
    {
        AccountState.DeleteAccount(id);
    }

    private void OpenDepositModal(AccountModel account)
    {
        selectedAccount = account;
        depositAmount = 0;
        showDepositModal = true;
    }

    private void CloseDepositModal()
    {
        showDepositModal = false;
        selectedAccount = null;
        depositAmount = 0;
    }

    private void ProcessDeposit()
    {
        if (selectedAccount != null && depositAmount > 0)
        {
            AccountState.UpdateBalance(selectedAccount.Id, depositAmount);
            CloseDepositModal();
        }
    }

    private void OpenTransferModal(AccountModel account)
    {
        // TODO: Implement transfer functionality
    }

    public void Dispose()
    {
        AccountState.OnChange -= StateHasChanged;
    }
}
