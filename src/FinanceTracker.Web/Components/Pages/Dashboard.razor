@page "/"
@using FinanceTracker.Web.States.Transactions
@using FinanceTracker.Web.States.Accounts
@inject TransactionState TransactionState
@inject AccountState AccountState
@rendermode InteractiveServer

<Sidebar />

<div class="main-content">
    <TopHeader />

    <!-- Metric Cards Grid -->
    <div class="dashboard-grid">
        <MetricCard Label="Ingresos" Value="@($"${TransactionState.GetTotalIncome():N2}")" />
        <MetricCard Label="Gastos" Value="@($"${TransactionState.GetTotalExpenses():N2}")" />
        <BalanceCard 
            Amount="@($"${GetTotalBalance():N2} USD")" 
            CardNumber="@(AccountState.Accounts.FirstOrDefault()?.Name ?? "N/A")" 
            CardDate="@DateTime.Now.ToString("MM / yy")" />
    </div>

    <!-- Transactions and Balance Section -->
    <div class="dashboard-grid">
        <div style="grid-column: span 2;">
            <TransactionList Transactions="GetTransactions()" />
        </div>
        
        <div>
            <div class="chart-container">
                <div class="chart-title">
                    Cuentas Activas
                    <button class="chart-filter">@DateTime.Now.Year â–¼</button>
                </div>
                <div style="padding: 20px;">
                    @foreach (var account in AccountState.Accounts.Take(3))
                    {
                        <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, @account.Color 0%, @account.Color + "aa" 100%); border-radius: 12px; color: white;">
                            <div style="font-size: 24px; margin-bottom: 5px;">
                                <span class="material-icons">@account.Icon</span>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">@account.Name</div>
                            <div style="font-size: 18px; font-weight: 700;">$@account.Balance.ToString("N2")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Account Summary -->
    <AccountSummary SummaryItems="GetSummaryItems()" />
</div>

@code {
    protected override void OnInitialized()
    {
        TransactionState.OnChange += StateHasChanged;
        AccountState.OnChange += StateHasChanged;
    }

    private decimal GetTotalBalance()
    {
        return AccountState.Accounts.Sum(a => a.Balance);
    }

    private List<TransactionList.TransactionItemModel> GetTransactions()
    {
        return TransactionState.GetRecentTransactions(5).Select(t => new TransactionList.TransactionItemModel
        {
            Icon = $"<span class='material-icons' style='color: {t.CategoryColor};'>{t.CategoryIcon}</span>",
            Name = t.Description,
            Date = t.Date.ToString("ddd, MMM d"),
            Amount = t.Amount >= 0 ? $"+${t.Amount:N2}" : $"-${Math.Abs(t.Amount):N2}"
        }).ToList();
    }

    private List<AccountSummary.SummaryItemModel> GetSummaryItems()
    {
        var weekTransactions = TransactionState.Transactions
            .Where(t => t.Date >= DateTime.Now.AddDays(-7))
            .Sum(t => t.Amount);
        
        var monthTransactions = TransactionState.Transactions
            .Where(t => t.Date >= DateTime.Now.AddMonths(-1))
            .Sum(t => t.Amount);

        return new()
        {
            new() { 
                Icon = "ðŸ“…",
                Label = "Esta Semana",
                Value = $"${Math.Abs(weekTransactions):N1}k",
                Color = "#e9a0d4",
                ChangePercentage = weekTransactions >= 0 ? $"+{weekTransactions:N1}%" : $"{weekTransactions:N1}%"
            },
            new() { 
                Icon = "ðŸ“Š",
                Label = "Este Mes",
                Value = $"${Math.Abs(monthTransactions):N1}k",
                Color = "#5b6eff",
                ChangePercentage = monthTransactions >= 0 ? $"+{monthTransactions:N1}%" : $"{monthTransactions:N1}%"
            },
            new() { 
                Icon = "ðŸ’°",
                Label = "Balance Total",
                Value = $"${GetTotalBalance():N1}k",
                Color = "#fbbf24",
                ChangePercentage = "+100%"
            }
        };
    }

    public void Dispose()
    {
        TransactionState.OnChange -= StateHasChanged;
        AccountState.OnChange -= StateHasChanged;
    }
}
