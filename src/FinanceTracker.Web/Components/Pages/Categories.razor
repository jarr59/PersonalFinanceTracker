@page "/categories"
@using FinanceTracker.Web.Components.Categories.ViewModels
@using FinanceTracker.Web.States.Categories
@using FinanceTracker.Web.Components.Categories
@using FinanceTracker.Web.Services.Categories
@using FinanceTracker.Web.States.Categories.DTOs
@using static FinanceTracker.Web.Components.Shared.Modal
@inject CategoryState CategoryState
@inject ICategoryServices CategoryService
@inherits StateAwareComponent

<Sidebar />

<div class="main-content">
    <TopHeader />

    <div class="page-header">
        <h1 class="page-title">Categorías</h1>
        <button class="btn-primary" @onclick="OpenAddModal">
            <span class="material-icons">add</span> Nueva Categoría
        </button>
    </div>

    <div class="categories-grid">
        @foreach (var category in CategoryState.Categories)
        {
            <CategoryCard CurrentCategory="@category"
                          OnDelete="@(() => DeleteCategory(category.Id))"
                          OnEdit="OpenEditModal"/>
        }
    </div>

    <CategoryModal IsVisible="@ShowModal"
                   Model="@CurrentCategory"
                   OnClose="@CloseModal"
                   OnSave="@SaveCategory" />
</div>

@code {
    /// <summary>
    /// Indica si debe mostar el modal
    /// </summary>
    private bool ShowModal = false;

    /// <summary>
    ///
    /// </summary>
    private ModalOperation ModalOperation = ModalOperation.Create;

    /// <summary>
    ///
    /// </summary>
    private CategoryModalVM CurrentCategory = new();

    protected override async Task OnInitializedAsync()
    {
        Subscribe(CategoryState);
        await CategoryService.LoadAllCategories();
        await base.OnInitializedAsync();
    }

    private void OpenAddModal()
    {
        ModalOperation = ModalOperation.Create;
        ShowModal = true;
    }

    private void OpenEditModal(Guid id)
    {
        ModalOperation = ModalOperation.Edit;

        CategoryModel? categoryFound = CategoryState.Categories.SingleOrDefault(e => e.Id == id);

        if (categoryFound != null)
        {
            CurrentCategory = new()
            {
                Id = categoryFound.Id,
                Name = categoryFound.Name.Name,
                Color = categoryFound.Color.Color,
                Icon = categoryFound.Icon.Source
            };

            ShowModal = true;
        }
    }

    private void CloseModal()
    {
        ShowModal = false;
    }

    private async Task SaveCategory(CategoryModalVM category)
    {
        if(ModalOperation == ModalOperation.Edit)
        {
            await CategoryService.UpdateCategoryAsync(id: category.Id!.Value, name: category.Name, colorHex: category.Color, iconSource: category.Icon);
        }
        if (ModalOperation == ModalOperation.Create)
        {
            await CategoryService.CreateCategoryAsync(name: category.Name, colorHex: category.Color, iconSource: category.Icon);
        }
        CloseModal();
    }

    private void DeleteCategory(Guid id)
    {
        // Por ahora, solo eliminar del estado (implementar DeleteCategoryCommand después)
        CategoryService.DeleteCategory(id);
    }
}

