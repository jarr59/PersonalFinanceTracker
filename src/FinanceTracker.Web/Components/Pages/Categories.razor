@page "/categories"
@using FinanceTracker.Web.Components.Categories.ViewModels
@using FinanceTracker.Web.States.Categories
@using FinanceTracker.Web.Components.Categories
@using FinanceTracker.Web.Services.Categories
@using FinanceTracker.Web.States.Categories.DTOs
@using Radzen
@using Radzen.Blazor
@using static FinanceTracker.Web.Components.Shared.Modal
@inject CategoryState CategoryState
@inject ICategoryServices CategoryService
@inherits StateAwareComponent

<Sidebar />

<div class="main-content">
    <TopHeader />

    <div class="page-header">
        <h1 class="page-title">Categorías</h1>
        <button class="btn-primary" @onclick="OpenAddModal" disabled="@CategoryState.IsBusy">
            <span class="material-icons">add</span> Nueva Categoría
        </button>
    </div>

    <div class="categories-container">
        @if (CategoryState.IsLoading)
        {
            <div class="loading-overlay" role="status" aria-label="Cargando categorías">
                <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
                    <Template>Cargando categorías...</Template>
                </RadzenProgressBarCircular>
            </div>
        }

        @if (CategoryState.IsDeleting)
        {
            <div class="action-overlay" role="status" aria-label="Eliminando categoría">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium">
                    <Template>Eliminando...</Template>
                </RadzenProgressBarCircular>
            </div>
        }

        <div class="categories-grid">
            @if (!CategoryState.IsLoading)
            {
                @foreach (var category in CategoryState.Categories)
                {
                    <CategoryCard CurrentCategory="@category"
                                  OnDelete="@(() => DeleteCategory(category.Id))"
                                  OnEdit="OpenEditModal" />
                }
            }
        </div>
    </div>

    <CategoryModal IsVisible="@ShowModal"
                   Model="@CurrentCategory"
                   IsEditing="@(ModalOperation == ModalOperation.Edit)"
                   OnClose="@CloseModal"
                   OnSave="@SaveCategory"
                   IsSaving="@(CategoryState.IsAdding || CategoryState.IsUpdating)" />
</div>

@code {
    private bool ShowModal = false;
    private ModalOperation ModalOperation = ModalOperation.Create;
    private CategoryModalVM CurrentCategory = new();

    protected override async Task OnInitializedAsync()
    {
        await Subscribe(CategoryState);
        await CategoryService.LoadAllCategories();
        await base.OnInitializedAsync();
    }

    private void OpenAddModal()
    {
        if (CategoryState.IsBusy) return;
        
        ModalOperation = ModalOperation.Create;
        CurrentCategory = new();
        ShowModal = true;
    }

    private void OpenEditModal(Guid id)
    {
        if (CategoryState.IsBusy) return;
        
        ModalOperation = ModalOperation.Edit;

        CategoryModel? categoryFound = CategoryState.Categories.SingleOrDefault(e => e.Id == id);

        if (categoryFound != null)
        {
            CurrentCategory = new()
            {
                Id = categoryFound.Id,
                Name = categoryFound.Name.Name,
                Color = categoryFound.Color.Color,
                Icon = categoryFound.Icon.Source
            };
            ShowModal = true;
        }
    }

    private void CloseModal()
    {
        if (CategoryState.IsAdding || CategoryState.IsUpdating) return;
        
        ShowModal = false;
        CurrentCategory = new();
    }

    private async Task SaveCategory(CategoryModalVM category)
    {
        if (CategoryState.IsAdding || CategoryState.IsUpdating) return;
        
        if (ModalOperation == ModalOperation.Edit)
        {
            await CategoryService.UpdateCategoryAsync(id: category.Id!.Value, name: category.Name, colorHex: category.Color, iconSource: category.Icon);
        }
        else if (ModalOperation == ModalOperation.Create)
        {
            await CategoryService.CreateCategoryAsync(name: category.Name, colorHex: category.Color, iconSource: category.Icon);
        }
        
        CloseModal();
    }

    private async Task DeleteCategory(Guid id)
    {
        if (CategoryState.IsDeleting) return;
        
        await CategoryService.DeleteCategoryAsync(id);
    }
}

